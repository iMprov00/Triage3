<%# Этап 1: уровень сознания %>
<div class="row align-items-start">
  <div class="col-12 col-md-8">
    <h1 class="page-title">Этап 1 — <%= @patient.full_name %></h1>
    <p class="text-muted small mb-0">Уровень сознания · 2 мин</p>
  </div>
  <div class="col-12 col-md-4 mb-3 mb-md-0">
    <div id="triage-timer" class="timer-box <%= @triage.expired? ? 'timer-expired' : 'timer-running' %>">
      <h4 class="text-center mb-0">
        <i class="bi bi-clock"></i>
        <span id="timer-display"><%= @triage.time_remaining %></span> сек
      </h4>
    </div>
  </div>
</div>

<div id="time-expired-warning" class="alert alert-warning <%= @triage.expired? ? '' : 'd-none' %>">
  <h4><i class="bi bi-exclamation-triangle"></i> Время вышло!</h4>
  <p class="mb-0 small">Таймер этапа истек, но вы можете продолжить заполнение формы.</p>
</div>

<form id="triage-form" action="/patients/<%= @patient.id %>/triage/step1" method="post" class="mt-4">
  <div class="app-card card mb-4">
    <div class="app-card-header card-header">
      <span class="text-muted small text-uppercase fw-normal">Уровень сознания</span>
    </div>
    <div class="card-body">
      <div class="row g-3">
        <div class="col-md-4">
          <label class="form-label">Открывание глаз</label>
          <select name="eye_opening" class="form-select" required>
            <option value="">Выберите...</option>
            <% Triage::EYE_OPENING_SCORES.each do |text, score| %>
              <option value="<%= text %>"><%= text %> (<%= score %> баллов)</option>
            <% end %>
          </select>
        </div>
        
        <div class="col-md-4">
          <label class="form-label">Речевые реакции</label>
          <select name="verbal_response" class="form-select" required>
            <option value="">Выберите...</option>
            <% Triage::VERBAL_SCORES.each do |text, score| %>
              <option value="<%= text %>"><%= text %> (<%= score %> баллов)</option>
            <% end %>
          </select>
        </div>
        
        <div class="col-md-4">
          <label class="form-label">Двигательные реакции</label>
          <select name="motor_response" class="form-select" required>
            <option value="">Выберите...</option>
            <% Triage::MOTOR_SCORES.each do |text, score| %>
              <option value="<%= text %>"><%= text %> (<%= score %> баллов)</option>
            <% end %>
          </select>
        </div>
      </div>
      
      <div class="mt-3 text-center">
        <div class="alert <%= @triage.total_consciousness_score <= 8 ? 'alert-danger' : 'alert-secondary' %>">
          <strong>Сумма баллов: <span id="total-score">0</span></strong>
          <div class="small text-muted">Если сумма ≤ 8 баллов - приоритет Красный</div>
        </div>
      </div>
    </div>
  </div>

  <div class="app-card card mb-4">
    <div class="app-card-header card-header">
      <span class="text-muted small text-uppercase fw-normal">Витальные функции и кровотечение</span>
    </div>
    <div class="card-body">
      <div class="row">
        <div class="col-md-3">
          <div class="form-check mb-3">
            <input class="form-check-input" type="checkbox" name="breathing" value="true" id="breathing">
            <label class="form-check-label" for="breathing">
              Дыхание
            </label>
          </div>
        </div>
        <div class="col-md-3">
          <div class="form-check mb-3">
            <input class="form-check-input" type="checkbox" name="heartbeat" value="true" id="heartbeat">
            <label class="form-check-label" for="heartbeat">
              Сердцебиение
            </label>
          </div>
        </div>
        <div class="col-md-3">
          <div class="form-check mb-3">
            <input class="form-check-input" type="checkbox" name="seizures" value="true" id="seizures">
            <label class="form-check-label" for="seizures">
              Судороги
            </label>
          </div>
        </div>
        <div class="col-md-3">
          <div class="form-check mb-3">
            <input class="form-check-input" type="checkbox" name="active_bleeding" value="true" id="active_bleeding">
            <label class="form-check-label" for="active_bleeding">
              Активное кровотечение
            </label>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <div class="d-grid gap-2 d-md-flex justify-content-md-end">
    <button type="submit" class="btn btn-success btn-lg">
      <i class="bi bi-arrow-right"></i> Далее (Этап 2)
    </button>
  </div>
</form>

<script>
// Подключение к SSE потоку
const eventSource = new EventSource('/triage_events/<%= @patient.id %>');

eventSource.onmessage = function(event) {
  const data = JSON.parse(event.data);
  const timerDisplay = $('#timer-display');
  const timerBox = $('#triage-timer');
  const warning = $('#time-expired-warning');
  
  // Обновление таймера
  timerDisplay.text(data.time_remaining);
  
  if (data.expired) {
    timerBox.removeClass('timer-running').addClass('timer-expired');
    
    // Просто показываем предупреждение, НЕ отправляем форму
    warning.removeClass('d-none');
  } else {
    timerBox.removeClass('timer-expired').addClass('timer-running');
    warning.addClass('d-none');
  }
};

// Расчет суммы баллов
function calculateTotalScore() {
  const eyeSelect = $('select[name="eye_opening"]');
  const verbalSelect = $('select[name="verbal_response"]');
  const motorSelect = $('select[name="motor_response"]');
  
  const eyeText = eyeSelect.val();
  const verbalText = verbalSelect.val();
  const motorText = motorSelect.val();
  
  const scores = {
    eye: <%= Triage::EYE_OPENING_SCORES.to_json %>,
    verbal: <%= Triage::VERBAL_SCORES.to_json %>,
    motor: <%= Triage::MOTOR_SCORES.to_json %>
  };
  
  let total = 0;
  if (eyeText && scores.eye[eyeText]) total += scores.eye[eyeText];
  if (verbalText && scores.verbal[verbalText]) total += scores.verbal[verbalText];
  if (motorText && scores.motor[motorText]) total += scores.motor[motorText];
  
  $('#total-score').text(total);
  
  // Подсветка если сумма ≤ 8
  if (total <= 8) {
    $('#total-score').closest('.alert').removeClass('alert-secondary').addClass('alert-danger');
  } else {
    $('#total-score').closest('.alert').removeClass('alert-danger').addClass('alert-secondary');
  }
}

// Слушаем изменения в селектах
$('select[name="eye_opening"], select[name="verbal_response"], select[name="motor_response"]').change(calculateTotalScore);

// Инициализация
calculateTotalScore();

// При закрытии страницы отключаем SSE
window.addEventListener('beforeunload', function() {
  eventSource.close();
});
</script>