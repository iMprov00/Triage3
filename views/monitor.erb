<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <title>Монитор Триажа — ТВ</title>
  <style>
    /* Встроенные базовые стили для гарантии работы */
    body { margin: 0; padding: 0; font-family: sans-serif; }
    .hidden { display: none !important; }
  </style>
  <link rel="stylesheet" href="/css/monitor.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
</head>
<body>
  <!-- ШАПКА -->
  <header class="monitor-header">
    <div class="monitor-title">
      <h1><i class="bi bi-hospital"></i> ТРИАЖ — МОНИТОР</h1>
      <span class="badge">ТВ-ДИСПЛЕЙ</span>
    </div>
    
    <div class="monitor-meta">
      <div class="meta-item">
        <span class="label">Время:</span>
        <span class="value time" id="current-time">--:--:--</span>
      </div>
      <div class="meta-item">
        <span class="label">Пациентов:</span>
        <span class="value" id="patients-count">0</span>
      </div>
      <div class="meta-item">
        <span class="label">Статус:</span>
        <div class="status-indicator">
          <span class="status-dot connected" id="status-dot"></span>
          <span id="status-text">Подключение...</span>
        </div>
      </div>
    </div>
  </header>

  <!-- ЛЕГЕНДА ПРИОРИТЕТОВ -->
  <div class="priority-legend">
    <div class="legend-item">
      <div class="legend-dot priority-1"></div>
      <span>1 — Красный (Неотложный)</span>
    </div>
    <div class="legend-item">
      <div class="legend-dot priority-2"></div>
      <span>2 — Желтый (Срочный)</span>
    </div>
    <div class="legend-item">
      <div class="legend-dot priority-3"></div>
      <span>3 — Фиолетовый (Плановый)</span>
    </div>
    <div class="legend-item">
      <div class="legend-dot priority-4"></div>
      <span>4 — Зеленый (Амбулаторный)</span>
    </div>
  </div>

  <!-- ОСНОВНОЙ КОНТЕНТ -->
  <main>
    <div id="patients-container" class="patients-container">
      <!-- Карточки пациентов будут вставляться здесь через JavaScript -->
    </div>

    <!-- СООБЩЕНИЕ ЕСЛИ НЕТ ПАЦИЕНТОВ -->
    <div id="no-patients" class="no-patients hidden">
      <h3><i class="bi bi-people"></i> Нет активных пациентов</h3>
      <p>Ожидание поступления новых пациентов...</p>
    </div>

    <!-- СТАТУС ПОТОКА ДАННЫХ -->
    <div id="stream-status" class="stream-status">
      <i class="bi bi-broadcast"></i> <span id="stream-status-text">Установка соединения...</span>
    </div>
  </main>

  <!-- ФУТЕР -->
  <footer class="monitor-footer">
    <div>
      <span>Монитор триажа • Система в реальном времени • </span>
      <span id="last-update">Обновлено: --:--:--</span>
    </div>
  </footer>

  <!-- ШАБЛОН КАРТОЧКИ ПАЦИЕНТА -->
  <template id="patient-card-template">
    <div class="patient-card" data-id="">
      <div class="patient-header">
        <h2 class="patient-name"></h2>
        <span class="patient-id"></span>
      </div>
      
      <div class="patient-info-grid">
        <div class="info-item">
          <span class="info-label"><i class="bi bi-person-badge"></i> Исполнитель:</span>
          <span class="info-value performer"></span>
        </div>
        <div class="info-item">
          <span class="info-label"><i class="bi bi-clipboard"></i> Вид обращения:</span>
          <span class="info-value appeal"></span>
        </div>
        <div class="info-item">
          <span class="info-label"><i class="bi bi-clock-history"></i> Поступил:</span>
          <span class="info-value admission-time"></span>
        </div>
        <div class="info-item">
          <span class="info-label"><i class="bi bi-heart-pulse"></i> Сознание:</span>
          <span class="info-value highlight consciousness"></span>
        </div>
      </div>
      
      <div class="patient-status">
        <span class="step-badge"></span>
        <span class="priority-badge"></span>
      </div>
      
      <div class="timer-section">
        <div class="timer-label">Таймер этапа:</div>
        <div class="timer-display normal"></div>
        <div class="timer-progress">
          <div class="timer-progress-bar normal" style="width: 100%"></div>
        </div>
      </div>
    </div>
  </template>

  <script>
    // Конфигурация
    const CONFIG = {
      UPDATE_INTERVAL: 1000, // 1 секунда
      MAX_TIMER_WARNING: 60, // секунд до предупреждения
      MAX_TIMER_CRITICAL: 30, // секунд до критического
      EVENT_SOURCE_URL: '/monitor_events'
    };

    // Глобальные переменные
    let eventSource = null;
    let patientsData = {};
    let lastUpdateTime = null;

    // DOM элементы
    const elements = {
      patientsContainer: document.getElementById('patients-container'),
      noPatients: document.getElementById('no-patients'),
      patientsCount: document.getElementById('patients-count'),
      currentTime: document.getElementById('current-time'),
      lastUpdate: document.getElementById('last-update'),
      statusDot: document.getElementById('status-dot'),
      statusText: document.getElementById('status-text'),
      streamStatus: document.getElementById('stream-status'),
      streamStatusText: document.getElementById('stream-status-text'),
      template: document.getElementById('patient-card-template')
    };

    // Вспомогательные функции
    function formatTime(seconds) {
      if (!seconds && seconds !== 0) return '--:--';
      const mins = Math.floor(seconds / 60);
      const secs = seconds % 60;
      return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
    }

    function getTimeClass(seconds) {
      if (seconds === undefined) return 'expired';
      if (seconds <= CONFIG.MAX_TIMER_CRITICAL) return 'critical';
      if (seconds <= CONFIG.MAX_TIMER_WARNING) return 'warning';
      return 'normal';
    }

    function getPriorityClass(priority) {
      return `priority-${priority}`;
    }

    function getPriorityText(priority) {
      const texts = {
        'red': '1 — Красный',
        'yellow': '2 — Желтый',
        'purple': '3 — Фиолетовый',
        'green': '4 — Зеленый'
      };
      return texts[priority] || priority;
    }

    function getStepText(step) {
      const texts = {
        1: 'Этап 1: Оценка сознания',
        2: 'Этап 2: Общая оценка',
        3: 'Этап 3: Витальные функции'
      };
      return texts[step] || `Этап ${step}`;
    }

    // Обновление времени
    function updateClock() {
      const now = new Date();
      const timeStr = now.toLocaleTimeString('ru-RU');
      elements.currentTime.textContent = timeStr;
      
      if (lastUpdateTime) {
        const diff = Math.floor((now - lastUpdateTime) / 1000);
        if (diff < 10) {
          elements.lastUpdate.textContent = `Обновлено: только что`;
        } else {
          elements.lastUpdate.textContent = `Обновлено: ${diff} сек назад`;
        }
      }
    }

    // Отрисовка карточки пациента
    function renderPatientCard(patient) {
      let card = elements.patientsContainer.querySelector(`[data-id="${patient.id}"]`);
      
      if (!card) {
        // Создаем новую карточку БЕЗ анимации
        card = elements.template.content.cloneNode(true).querySelector('.patient-card');
        card.dataset.id = patient.id;
        elements.patientsContainer.appendChild(card);
        card = elements.patientsContainer.querySelector(`[data-id="${patient.id}"]`);
        
        // Плавное появление только для новых карточек
        card.style.opacity = '0';
        setTimeout(() => {
          card.style.transition = 'opacity 0.3s ease';
          card.style.opacity = '1';
        }, 10);
      }
      
      // Остальной код остается без изменений...
      // Обновляем класс приоритета
      const priorityClass = getPriorityClass(patient.priority);
      card.className = `patient-card ${priorityClass}`;
      
      // Заполняем данные
      card.querySelector('.patient-name').textContent = patient.full_name;
      card.querySelector('.patient-id').textContent = `ID: ${patient.id}`;
      card.querySelector('.performer').textContent = patient.performer_name || 'Не указан';
      card.querySelector('.appeal').textContent = patient.appeal_type || '—';
      card.querySelector('.admission-time').textContent = patient.admission_time || '—';
      card.querySelector('.consciousness').textContent = patient.consciousness_score || '0';
      
      // Этап и приоритет
      const stepBadge = card.querySelector('.step-badge');
      stepBadge.textContent = getStepText(patient.step);
      stepBadge.className = `step-badge step-${patient.step}`;
      
      const priorityBadge = card.querySelector('.priority-badge');
      priorityBadge.textContent = getPriorityText(patient.priority);
      priorityBadge.className = `priority-badge ${priorityClass}`;
      
      // Таймер
      updatePatientTimer(card, patient);
    }

    function updatePatientTimer(card, patient) {
      const timeRemaining = patient.time_remaining || 0;
      const timerDisplay = card.querySelector('.timer-display');
      const timerBar = card.querySelector('.timer-progress-bar');
      
      const timeClass = getTimeClass(timeRemaining);
      timerDisplay.textContent = formatTime(timeRemaining);
      timerDisplay.className = `timer-display ${timeClass}`;
      timerBar.className = `timer-progress-bar ${timeClass}`;
      
      // Прогресс-бар (простая визуализация)
      let percent = 100;
      if (patient.max_time && patient.max_time > 0) {
        percent = Math.max(0, (timeRemaining / patient.max_time) * 100);
      }
      timerBar.style.width = `${percent}%`;
    }

    // Обновление всех карточек
    function renderAllPatients(patients) {
      lastUpdateTime = new Date();
      
      // Обновляем счетчик
      elements.patientsCount.textContent = patients.length;
      
      if (patients.length === 0) {
        elements.noPatients.classList.remove('hidden');
        elements.patientsContainer.innerHTML = '';
        return;
      }
      
      elements.noPatients.classList.add('hidden');
      
      // Сохраняем текущие ID для удаления отсутствующих пациентов
      const currentIds = new Set(patients.map(p => p.id));
      const existingCards = elements.patientsContainer.querySelectorAll('.patient-card');
      
      // Удаляем карточки пациентов, которых больше нет
      existingCards.forEach(card => {
        const id = parseInt(card.dataset.id);
        if (!currentIds.has(id)) {
          card.remove();
        }
      });
      
      // Обновляем или создаем карточки
      patients.forEach(patient => {
        renderPatientCard(patient);
      });
      
      // Сортируем по приоритету (красные сверху)
      const container = elements.patientsContainer;
      const cards = Array.from(container.querySelectorAll('.patient-card'));
      
      const priorityOrder = { 'red': 1, 'yellow': 2, 'purple': 3, 'green': 4 };
      
      cards.sort((a, b) => {
        const aPriority = a.className.includes('priority-1') ? 1 : 
                         a.className.includes('priority-2') ? 2 :
                         a.className.includes('priority-3') ? 3 : 4;
        const bPriority = b.className.includes('priority-1') ? 1 : 
                         b.className.includes('priority-2') ? 2 :
                         b.className.includes('priority-3') ? 3 : 4;
        return aPriority - bPriority;
      });
      
      // Переставляем карточки в правильном порядке
      cards.forEach(card => container.appendChild(card));
    }

    // Подключение к SSE
    function connectSSE() {
      try {
        if (eventSource) {
          eventSource.close();
        }
        
        eventSource = new EventSource(CONFIG.EVENT_SOURCE_URL);
        

        
        eventSource.onmessage = (event) => {
          try {
            const patients = JSON.parse(event.data);
            patientsData = patients.reduce((acc, p) => {
              acc[p.id] = p;
              return acc;
            }, {});
            
            // Добавляем максимальное время для каждого этапа
            const maxTimes = { 1: 120, 2: 300, 3: 600 };
            patients.forEach(p => {
              p.max_time = maxTimes[p.step] || 120;
            });
            
            renderAllPatients(patients);
          } catch (e) {
            console.error('Ошибка парсинга данных:', e);
          }
        };
        

        
      } catch (e) {
        console.error('Ошибка SSE:', e);
        updateStatus('disconnected', 'Ошибка подключения');
        setTimeout(connectSSE, 10000); // Повторная попытка через 10 сек
      }
    }

    // Обновление статуса подключения
    function updateStatus(status, text) {
      elements.statusDot.className = `status-dot ${status}`;
      elements.statusText.textContent = text;
      elements.streamStatus.className = `stream-status ${status}`;
      elements.streamStatusText.textContent = text;
    }

    // Анимация обновления времени
    function updateTimers() {
      const now = Date.now() / 1000;
      const cards = elements.patientsContainer.querySelectorAll('.patient-card');
      
      cards.forEach(card => {
        const timerDisplay = card.querySelector('.timer-display');
        const timerBar = card.querySelector('.timer-progress-bar');
        
        // Получаем данные пациента
        const patientId = parseInt(card.dataset.id);
        const patient = patientsData[patientId];
        
        if (!patient || patient.time_remaining === undefined) return;
        
        // Обновляем оставшееся время
        let timeRemaining = patient.time_remaining;
        if (patient.timer_ends_at) {
          timeRemaining = Math.max(0, Math.floor(patient.timer_ends_at - now));
        }
        
        // Обновляем отображение
        const timeClass = getTimeClass(timeRemaining);
        timerDisplay.textContent = formatTime(timeRemaining);
        timerDisplay.className = `timer-display ${timeClass}`;
        timerBar.className = `timer-progress-bar ${timeClass}`;
        
        // Обновляем прогресс-бар
        if (patient.max_time && patient.max_time > 0) {
          const percent = Math.max(0, (timeRemaining / patient.max_time) * 100);
          timerBar.style.width = `${percent}%`;
        }
      });
    }

    // Инициализация
    document.addEventListener('DOMContentLoaded', () => {
      // Обновляем часы каждую секунду
      updateClock();
      setInterval(updateClock, 1000);
      
      // Обновляем таймеры каждую секунду
      setInterval(updateTimers, 1000);
      
      // Подключаемся к SSE
      connectSSE();
      
      // Фокус на окне для предотвращения сна экрана
      window.addEventListener('focus', () => {
        if (!eventSource || eventSource.readyState === EventSource.CLOSED) {
          connectSSE();
        }
      });
      
      // Обработка видимости страницы
      document.addEventListener('visibilitychange', () => {
        if (!document.hidden && (!eventSource || eventSource.readyState === EventSource.CLOSED)) {
          connectSSE();
        }
      });
    });

    // Автоматическое обновление при потере соединения
    window.addEventListener('online', () => {
      if (!eventSource || eventSource.readyState === EventSource.CLOSED) {
        connectSSE();
      }
    });
  </script>
</body>
</html>