<%# Регистрация нового пациента %>
<h1 class="page-title">Новый пациент</h1>

<div class="app-card card">
  <div class="app-card-header card-header">
    <span class="text-muted small text-uppercase fw-normal">Данные пациента</span>
  </div>
  <div class="card-body">
    <form action="/patients" method="post">
      <div class="row g-3">
        <div class="col-12 col-md-6">
          <label class="form-label">ФИО пациента</label>
          <input type="text" name="full_name" class="form-control" required placeholder="Фамилия Имя Отчество">
        </div>
        <div class="col-12 col-md-6">
          <label class="form-label">ФИО исполнителя</label>
          <input type="text" name="performer_name" class="form-control" required placeholder="Исполнитель">
        </div>
        <div class="col-6 col-md-3">
          <label class="form-label">Дата поступления</label>
          <input type="date" name="admission_date" class="form-control" value="<%= Date.today %>" required>
        </div>
        <div class="col-6 col-md-3">
          <label class="form-label">Время поступления</label>
          <input type="time" name="admission_time" class="form-control" value="<%= format_nsk(Time.now, '%H:%M') %>" required>
        </div>
        <div class="col-12 col-md-6">
          <label class="form-label">Дата рождения*</label>
          <div class="row g-2">
            <div class="col-4">
              <select name="birth_day" class="form-select" id="birth_day" required>
                <option value="">День</option>
                <% (1..31).each do |day| %>
                  <option value="<%= day %>"><%= day %></option>
                <% end %>
              </select>
            </div>
            <div class="col-4">
              <select name="birth_month" class="form-select" id="birth_month" required>
                <option value="">Месяц</option>
                <% 
                  months = [
                    ['Январь', 1], ['Февраль', 2], ['Март', 3], ['Апрель', 4],
                    ['Май', 5], ['Июнь', 6], ['Июль', 7], ['Август', 8],
                    ['Сентябрь', 9], ['Октябрь', 10], ['Ноябрь', 11], ['Декабрь', 12]
                  ]
                %>
                <% months.each do |name, value| %>
                  <option value="<%= value %>"><%= name %></option>
                <% end %>
              </select>
            </div>
            <div class="col-4">
              <select name="birth_year" class="form-select" id="birth_year" required>
                <option value="">Год</option>
                <% current_year = Date.today.year %>
                <% (current_year - 120..current_year).reverse_each do |year| %>
                  <option value="<%= year %>"><%= year %></option>
                <% end %>
              </select>
            </div>
          </div>
          <!-- Скрытое поле для отправки даты в формате YYYY-MM-DD -->
          <input type="hidden" name="birth_date" id="birth_date_hidden">
        </div>
        <div class="col-12 col-md-6">
          <label class="form-label">Вид обращения</label>
          <select name="appeal_type" class="form-select" required>
            <option value="">Выберите вид обращения...</option>
            <% Patient::APPEAL_TYPES.each do |type| %>
              <option value="<%= type %>"><%= type %></option>
            <% end %>
          </select>
        </div>
        <div class="col-12 col-md-6">
          <label class="form-label">Срок беременности</label>
          <div class="input-group">
            <input type="number" name="pregnancy_weeks" class="form-control" step="0.1" min="0" max="42"
                   id="pregnancy_weeks_input" placeholder="Недель">
            <span class="input-group-text">недель</span>
          </div>
          <div class="form-check mt-2">
            <input type="checkbox" name="pregnancy_unknown" class="form-check-input" id="pregnancy_unknown_checkbox" value="1">
            <label class="form-check-label" for="pregnancy_unknown_checkbox">Неизвестно</label>
          </div>
        </div>
      </div>
      <div class="action-bar mt-4">
        <button type="submit" class="btn btn-primary">Сохранить и перейти к триажу</button>
        <a href="/patients" class="btn btn-secondary">Отмена</a>
      </div>
    </form>
  </div>
</div>

<script>


// Объединяем день, месяц и год в одну дату
function updateBirthDate() {
  const day = document.getElementById('birth_day').value;
  const month = document.getElementById('birth_month').value;
  const year = document.getElementById('birth_year').value;
  
  if (day && month && year) {
    const dateStr = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
    document.getElementById('birth_date_hidden').value = dateStr;
  }
}

// Для редактирования: разбираем существующую дату
<% if @patient %>
  document.addEventListener('DOMContentLoaded', function() {
    const birthDate = '<%= @patient.birth_date %>';
    if (birthDate) {
      const date = new Date(birthDate);
      document.getElementById('birth_day').value = date.getDate();
      document.getElementById('birth_month').value = date.getMonth() + 1;
      document.getElementById('birth_year').value = date.getFullYear();
      updateBirthDate();
    }
  });
<% end %>

// Слушаем изменения в селектах
['birth_day', 'birth_month', 'birth_year'].forEach(id => {
  document.getElementById(id).addEventListener('change', updateBirthDate);
});
  
// Галочка «Неизвестно» отключает поле срока беременности
document.getElementById('pregnancy_unknown_checkbox').addEventListener('change', function() {
  var input = document.getElementById('pregnancy_weeks_input');
  if (this.checked) {
    input.disabled = true;
    input.value = '';
    input.removeAttribute('required');
  } else {
    input.disabled = false;
  }
});
document.querySelector('form').addEventListener('submit', function(e) {
  var unknownChecked = document.getElementById('pregnancy_unknown_checkbox').checked;
  var weeksInput = document.getElementById('pregnancy_weeks_input');
  if (!unknownChecked && !weeksInput.value.trim()) {
    e.preventDefault();
    alert('Укажите срок беременности или отметьте «Неизвестно»');
  }
});
</script>
