<%# Список пациентов — заголовок и действия %>
<div class="d-flex flex-wrap align-items-center justify-content-between gap-3 mb-4">
  <h1 class="page-title mb-0">Пациенты</h1>
  <div class="action-bar">
    <a href="/patients/new" class="btn btn-primary"><i class="bi bi-plus-lg"></i> Новый пациент</a>
    <button type="button" class="btn btn-secondary" data-bs-toggle="modal" data-bs-target="#statsModal">
      <i class="bi bi-bar-chart"></i> Статистика
    </button>
  </div>
</div>

<%# Фильтры %>
<div class="app-card card mb-4 filters-card">
  <div class="app-card-header card-header">
    <span class="text-muted small text-uppercase fw-normal">Поиск и фильтры</span>
  </div>
  <div class="card-body">
    <form method="get" action="/patients" class="row g-3">
      <!-- Поиск по всем полям -->
      <div class="col-md-4">
        <label class="form-label">Поиск по всем полям</label>
        <div class="input-group">
          <input type="text" name="search" class="form-control" 
                 placeholder="ФИО, ID, исполнитель..." 
                 value="<%= params[:search] %>">
          <button class="btn btn-outline-secondary" type="submit">
            <i class="bi bi-search"></i>
          </button>
        </div>
      </div>
      
      <!-- Фильтр по дате поступления -->
      <!-- Фильтр по дате поступления -->
      <div class="col-md-4">
        <label class="form-label">Дата поступления</label>
        <input type="date" name="admission_date" class="form-control" 
               value="<%= params[:admission_date] || Date.today.to_s %>">
      </div>
      
      <!-- Фильтр по виду обращения -->
      <div class="col-md-2">
        <label class="form-label">Вид обращения</label>
        <select name="appeal_type" class="form-select">
          <option value="all">Все виды</option>
          <% Patient::APPEAL_TYPES.each do |type| %>
            <option value="<%= type %>" <%= 'selected' if params[:appeal_type] == type %>>
              <%= type %>
            </option>
          <% end %>
        </select>
      </div>
      
      <!-- Фильтр по сроку беременности -->
      <div class="col-md-2">
        <label class="form-label">Срок беременности</label>
        <select name="pregnancy_condition" class="form-select">
          <option value="">Все</option>
          <option value="unknown" <%= 'selected' if params[:pregnancy_condition] == 'unknown' %>>
            Неизвестно
          </option>
          <option value="less_12" <%= 'selected' if params[:pregnancy_condition] == 'less_12' %>>
            Менее 12 недель
          </option>
          <option value="12_28" <%= 'selected' if params[:pregnancy_condition] == '12_28' %>>
            12-28 недель
          </option>
          <option value="more_28" <%= 'selected' if params[:pregnancy_condition] == 'more_28' %>>
            Более 28 недель
          </option>
        </select>
      </div>
      
      <!-- Фильтр по исполнителю -->
      <div class="col-md-4">
        <label class="form-label">Исполнитель</label>
        <select name="performer_filter" class="form-select">
          <option value="">Все исполнители</option>
          <% @performers.each do |performer| %>
            <option value="<%= performer %>" <%= 'selected' if params[:performer_filter] == performer %>>
              <%= performer %>
            </option>
          <% end %>
        </select>
      </div>
      
      
      <div class="col-12 action-bar">
        <button type="submit" class="btn btn-primary"><i class="bi bi-search"></i> Применить</button>
        <a href="/patients" class="btn btn-secondary">Сбросить</a>
      </div>
    </form>
  </div>
</div>

<%# Подсчёт статистики для карточек и модального окна %>
<%
  total_patients = @patients.size
  active_triages = @patients.count { |p| p.triage&.timer_active }
  completed_triages = @patients.count { |p| p.triage&.completed_at }
  patients_with_triage = @patients.count { |p| p.triage }
  priority_stats = {}
  Triage::PRIORITIES.each_key { |k| priority_stats[k] = 0 }
  @patients.each do |p|
    next unless p.triage&.priority
    pr = p.triage.priority
    priority_stats[pr] = (priority_stats[pr] || 0) + 1
  end
%>

<%# Карточки статистики: всего, активные триажи, завершённые, красные приоритеты %>
<div class="row g-3 mb-4">
  <div class="col-6 col-md-3">
    <div class="stat-card bg-primary">
      <div>
        <div class="stat-label">Всего пациентов</div>
        <div class="stat-value"><%= total_patients %></div>
      </div>
      <i class="bi bi-people"></i>
    </div>
  </div>
  <div class="col-6 col-md-3">
    <div class="stat-card bg-warning text-dark">
      <div>
        <div class="stat-label">Активных триажей</div>
        <div class="stat-value"><%= active_triages %></div>
      </div>
      <i class="bi bi-clock"></i>
    </div>
  </div>
  <div class="col-6 col-md-3">
    <div class="stat-card bg-success">
      <div>
        <div class="stat-label">Завершенных триажей</div>
        <div class="stat-value"><%= completed_triages %></div>
      </div>
      <i class="bi bi-check-circle"></i>
    </div>
  </div>
  <div class="col-6 col-md-3">
    <div class="stat-card bg-danger">
      <div>
        <div class="stat-label">Красных приоритетов</div>
        <div class="stat-value"><%= priority_stats['red'] %></div>
      </div>
      <i class="bi bi-exclamation-triangle"></i>
    </div>
  </div>
</div>

<div id="server-down-alert" class="alert alert-danger alert-dismissible fade d-none" role="alert">
  <i class="bi bi-wifi-off"></i> Сервер не отвечает. Данные могут быть устаревшими.
  <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Закрыть"></button>
</div>
<%# Сетка карточек пациентов: обновляется по polling в реальном времени %>
<div id="patients-list-container" class="row patient-list">
  <% if @patients.empty? %>
    <div class="col-12">
      <div class="alert alert-info">
        <i class="bi bi-info-circle"></i> Пациенты не найдены
      </div>
    </div>
  <% else %>
    <% @patients.each do |patient| %>
      <div class="col-12 col-sm-6 col-lg-4 col-card">
        <div class="app-card card h-100">
          <div class="card-body">
            <!-- Заголовок с ID и ФИО -->
            <h5 class="card-title">
              <span class="badge bg-secondary">ID: <%= patient.id %></span>
              <%= patient.full_name %>
            </h5>
            
            <!-- Основная информация -->
            <div class="card-text mb-3">
              <div class="row small text-muted">
                <div class="col-12">
                  <strong><i class="bi bi-calendar"></i> Поступил:</strong> 
                  <%= patient.admission_date %> <%= patient.admission_time %>
                </div>
                <div class="col-12">
                  <strong><i class="bi bi-person-badge"></i> Исполнитель:</strong> 
                  <%= patient.performer_name %>
                </div>
                <div class="col-12">
                  <strong><i class="bi bi-clipboard"></i> Вид обращения:</strong> 
                  <span class="badge bg-info"><%= patient.appeal_type %></span>
                </div>
                <div class="col-12">
                  <strong><i class="bi bi-calendar-heart"></i> Срок беременности:</strong> 
                  <%= patient.pregnancy_display %>
                </div>
              </div>
            </div>
            
            <!-- Информация о триаже -->
            <% if patient.triage %>
              <div class="mb-3">
                <!-- Этап и приоритет -->
                <div class="d-flex justify-content-between align-items-center mb-2">
                  <div>
                    <!-- Исправленный блок с этапом -->
                    <%
                      step_class = case patient.triage.step
                        when 1 then 'bg-primary'
                        when 2 then 'bg-warning'
                        when 3 then 'bg-success'
                        else 'bg-secondary'
                      end
                    %>
                    <span class="badge <%= step_class %>">
                      Этап <%= patient.triage.step %>
                    </span>
                    
                    <% if patient.triage.priority != 'pending' %>
                      <%
                        priority_badge_class = case patient.triage.priority
                          when 'red' then 'bg-danger'
                          when 'yellow' then 'bg-warning'
                          when 'purple' then 'bg-purple'
                          when 'green' then 'bg-success'
                          else 'bg-secondary'
                        end
                      %>
                      <span class="badge <%= priority_badge_class %>">
                        <%= patient.triage.priority_name %>
                      </span>
                    <% end %>
                  </div>
                  
                  <% if patient.triage.completed_at %>
                    <span class="badge bg-success">
                      <i class="bi bi-check-circle"></i> Завершен
                    </span>
                  <% end %>
                </div>
                
                <!-- Таймер -->
                <% max_time = case patient.triage.step when 1 then 120 when 2 then 300 when 3 then 600 else 120 end %>
                <div class="timer-box <%= patient.triage.expired? ? 'timer-expired' : 'timer-running' %>" data-timer-ends-at="<%= patient.triage.timer_ends_at || 0 %>" data-step-max="<%= max_time %>" data-patient-id="<%= patient.id %>">
                  <div class="d-flex justify-content-between align-items-center">
                    <span>Таймер этапа:</span>
                    <span class="timer-value fw-bold"><%= patient.triage.time_remaining %> сек</span>
                  </div>
                  
                  <div class="progress mt-2" style="height: 5px;">
                    <% 
                      percent = (patient.triage.time_remaining.to_f / max_time * 100).to_i
                      progress_class = percent <= 25 ? 'bg-danger' : (percent <= 50 ? 'bg-warning' : 'bg-success')
                    %>
                    <div class="progress-bar <%= progress_class %>" style="width: <%= percent %>%"></div>
                  </div>
                  
                  <% if patient.triage.expired? && patient.triage.timer_active %>
                    <div class="alert alert-danger mt-2 mb-0 py-1">
                      <i class="bi bi-exclamation-triangle"></i> Время вышло!
                    </div>
                  <% end %>
                </div>
              </div>
              
              <!-- Кнопки действий -->
              <div class="mt-2">
                <% if patient.triage.timer_active && !patient.triage.completed_at %>
                  <% 
                    link = case patient.triage.step
                      when 1 then "/patients/#{patient.id}/triage"
                      when 2 then "/patients/#{patient.id}/triage/step2"
                      when 3 then "/patients/#{patient.id}/triage/step3"
                      else "/patients/#{patient.id}/triage"
                    end
                    
                    btn_class = case patient.triage.step
                      when 1 then 'btn-primary'
                      when 2 then 'btn-warning'
                      when 3 then 'btn-success'
                      else 'btn-secondary'
                    end
                    
                    btn_text = case patient.triage.step
                      when 1 then 'Этап 1'
                      when 2 then 'Этап 2'
                      when 3 then 'Этап 3'
                      else 'Продолжить'
                    end
                  %>
                  
                  <a href="<%= link %>" class="btn <%= btn_class %> btn-sm w-100 mb-2">
                    <i class="bi bi-clipboard-pulse"></i> <%= btn_text %>
                  </a>
                <% elsif patient.triage.completed_at %>
                  <a href="/patients/<%= patient.id %>/triage/actions" class="btn btn-info btn-sm w-100 mb-2">
                    <i class="bi bi-eye"></i> Действия (<%= patient.triage.priority_name %>)
                  </a>
                  <a href="/patients/<%= patient.id %>/triage" class="btn btn-outline-secondary btn-sm w-100">
                    <i class="bi bi-file-text"></i> Просмотр данных
                  </a>
                <% end %>
              </div>
            <% else %>
              <div class="alert alert-warning">
                <i class="bi bi-exclamation-circle"></i> Триаж не создан
                <a href="/patients/<%= patient.id %>/triage" class="btn btn-sm btn-primary mt-2">Начать триаж</a>
              </div>
            <% end %>
          </div>
          <div class="app-card-footer card-footer text-muted small">
            <i class="bi bi-clock-history"></i> Создан: <%= patient.created_at.strftime("%d.%m.%Y %H:%M") %>
          </div>
        </div>
      </div>
    <% end %>
  <% end %>
</div>

<%# Модальное окно: распределение по приоритетам и статусам %>
<div class="modal fade" id="statsModal" tabindex="-1" aria-labelledby="statsModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="statsModalLabel"><i class="bi bi-graph-up"></i> Статистика триажа</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="row">
          <div class="col-md-6">
            <h6>Распределение по приоритетам:</h6>
            <ul class="list-group">
              <% Triage::PRIORITIES.each do |key, data| %>
                <%
                  badge_color = case key
                    when 'red' then 'bg-danger'
                    when 'yellow' then 'bg-warning'
                    when 'purple' then 'bg-purple'
                    when 'green' then 'bg-success'
                    else 'bg-secondary'
                  end
                %>
                <li class="list-group-item d-flex justify-content-between align-items-center">
                  <span class="badge <%= badge_color %> me-2" style="width: 20px;">&nbsp;</span>
                  <%= data[:name] %>
                  <span class="badge bg-primary rounded-pill"><%= priority_stats[key] %></span>
                </li>
              <% end %>
            </ul>
          </div>
          <div class="col-md-6">
            <h6>Статус триажей:</h6>
            <ul class="list-group">
              <li class="list-group-item d-flex justify-content-between align-items-center">
                Активные триажи
                <span class="badge bg-warning rounded-pill"><%= active_triages %></span>
              </li>
              <li class="list-group-item d-flex justify-content-between align-items-center">
                Завершенные триажи
                <span class="badge bg-success rounded-pill"><%= completed_triages %></span>
              </li>
              <li class="list-group-item d-flex justify-content-between align-items-center">
                Без триажа
                <span class="badge bg-secondary rounded-pill"><%= total_patients - patients_with_triage %></span>
              </li>
            </ul>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
      </div>
    </div>
  </div>
</div>

<script>
var serverDown = false;

function stepClass(s) { return s === 1 ? 'bg-primary' : (s === 2 ? 'bg-warning' : (s === 3 ? 'bg-success' : 'bg-secondary')); }
function priorityClass(p) { return p === 'red' ? 'bg-danger' : (p === 'yellow' ? 'bg-warning' : (p === 'purple' ? 'bg-purple' : (p === 'green' ? 'bg-success' : 'bg-secondary'))); }

function renderPatientsList(patients) {
  var container = $('#patients-list-container');
  if (!patients || patients.length === 0) {
    container.html('<div class="col-12"><div class="alert alert-info"><i class="bi bi-info-circle"></i> Пациенты не найдены</div></div>');
    return;
  }
  var html = '';
  patients.forEach(function(p) {
    var t = p.triage;
    if (!t) {
      html += '<div class="col-12 col-sm-6 col-lg-4 col-card"><div class="app-card card h-100"><div class="card-body">';
      html += '<h5 class="card-title"><span class="badge bg-secondary">ID: ' + p.id + '</span> ' + escapeHtml(p.full_name) + '</h5>';
      html += '<div class="card-text mb-3"><div class="row small text-muted"><div class="col-12"><strong><i class="bi bi-calendar"></i> Поступил:</strong> ' + (p.admission_date || '') + ' ' + (p.admission_time || '') + '</div>';
      html += '<div class="col-12"><strong><i class="bi bi-person-badge"></i> Исполнитель:</strong> ' + escapeHtml(p.performer_name || '') + '</div>';
      html += '<div class="col-12"><strong><i class="bi bi-clipboard"></i> Вид обращения:</strong> <span class="badge bg-info">' + escapeHtml(p.appeal_type || '') + '</span></div>';
      html += '<div class="col-12"><strong><i class="bi bi-calendar-heart"></i> Срок беременности:</strong> ' + escapeHtml(p.pregnancy_display || '') + '</div></div></div>';
      html += '<div class="alert alert-warning"><i class="bi bi-exclamation-circle"></i> Триаж не создан <a href="/patients/' + p.id + '/triage" class="btn btn-sm btn-primary mt-2">Начать триаж</a></div></div>';
      html += '<div class="app-card-footer card-footer text-muted small"><i class="bi bi-clock-history"></i> Создан: ' + (p.created_at || '') + '</div></div></div>';
      return;
    }
    var maxTime = t.max_time || 120;
    var endsAt = t.timer_ends_at || 0;
    var tr = t.time_remaining || 0;
    var percent = maxTime ? Math.round((tr / maxTime) * 100) : 0;
    var progClass = percent <= 25 ? 'bg-danger' : (percent <= 50 ? 'bg-warning' : 'bg-success');
    var timerBoxClass = t.expired ? 'timer-expired' : 'timer-running';
    html += '<div class="col-12 col-sm-6 col-lg-4 col-card"><div class="app-card card h-100"><div class="card-body">';
    html += '<h5 class="card-title"><span class="badge bg-secondary">ID: ' + p.id + '</span> ' + escapeHtml(p.full_name) + '</h5>';
    html += '<div class="card-text mb-3"><div class="row small text-muted"><div class="col-12"><strong><i class="bi bi-calendar"></i> Поступил:</strong> ' + (p.admission_date || '') + ' ' + (p.admission_time || '') + '</div>';
    html += '<div class="col-12"><strong><i class="bi bi-person-badge"></i> Исполнитель:</strong> ' + escapeHtml(p.performer_name || '') + '</div>';
    html += '<div class="col-12"><strong><i class="bi bi-clipboard"></i> Вид обращения:</strong> <span class="badge bg-info">' + escapeHtml(p.appeal_type || '') + '</span></div>';
    html += '<div class="col-12"><strong><i class="bi bi-calendar-heart"></i> Срок беременности:</strong> ' + escapeHtml(p.pregnancy_display || '') + '</div></div></div>';
    html += '<div class="mb-3"><div class="d-flex justify-content-between align-items-center mb-2"><div>';
    html += '<span class="badge ' + stepClass(t.step) + '">Этап ' + (t.step || 1) + '</span> ';
    if (t.priority && t.priority !== 'pending') {
      html += '<span class="badge ' + priorityClass(t.priority) + '">' + escapeHtml(t.priority_name || t.priority) + '</span>';
    }
    html += '</div>';
    if (t.completed_at) html += '<span class="badge bg-success"><i class="bi bi-check-circle"></i> Завершен</span>';
    html += '</div>';
    html += '<div class="timer-box ' + timerBoxClass + '" data-timer-ends-at="' + endsAt + '" data-step-max="' + maxTime + '" data-patient-id="' + p.id + '">';
    html += '<div class="d-flex justify-content-between align-items-center"><span>Таймер этапа:</span><span class="timer-value fw-bold">' + tr + ' сек</span></div>';
    html += '<div class="progress mt-2" style="height: 5px;"><div class="progress-bar ' + progClass + '" style="width: ' + percent + '%"></div></div>';
    if (t.expired && t.timer_active) html += '<div class="alert alert-danger mt-2 mb-0 py-1"><i class="bi bi-exclamation-triangle"></i> Время вышло!</div>';
    html += '</div></div><div class="mt-2">';
    if (t.timer_active && !t.completed_at) {
      var step = t.step || 1;
      var link = step === 1 ? '/patients/' + p.id + '/triage' : (step === 2 ? '/patients/' + p.id + '/triage/step2' : '/patients/' + p.id + '/triage/step3');
      var btnCls = step === 1 ? 'btn-primary' : (step === 2 ? 'btn-warning' : 'btn-success');
      html += '<a href="' + link + '" class="btn ' + btnCls + ' btn-sm w-100 mb-2"><i class="bi bi-clipboard-pulse"></i> Этап ' + step + '</a>';
    } else if (t.completed_at) {
      html += '<a href="/patients/' + p.id + '/triage/actions" class="btn btn-info btn-sm w-100 mb-2"><i class="bi bi-eye"></i> Действия (' + escapeHtml(t.priority_name || '') + ')</a>';
      html += '<a href="/patients/' + p.id + '/triage" class="btn btn-outline-secondary btn-sm w-100"><i class="bi bi-file-text"></i> Просмотр данных</a>';
    }
    html += '</div></div><div class="app-card-footer card-footer text-muted small"><i class="bi bi-clock-history"></i> Создан: ' + (p.created_at || '') + '</div></div></div>';
  });
  container.html(html);
}

function escapeHtml(s) {
  if (!s) return '';
  var div = document.createElement('div');
  div.textContent = s;
  return div.innerHTML;
}

function fetchPatientsList() {
  var qs = window.location.search || '';
  $.ajax({
    url: '/api/patients_list' + qs,
    type: 'GET',
    dataType: 'json',
    success: function(patients) {
      serverDown = false;
      $('#server-down-alert').addClass('d-none');
      renderPatientsList(patients);
    },
    error: function() {
      serverDown = true;
      $('#server-down-alert').removeClass('d-none').addClass('show');
    }
  });
}

function updateAllTimers() {
  if (serverDown) {
    $('[data-timer-ends-at]').each(function() {
      var box = $(this);
      if (parseFloat(box.data('timer-ends-at')) > 0) {
        box.find('.timer-value').text('Сервер не отвечает');
        box.find('.progress').hide();
        box.addClass('timer-expired');
      }
    });
    return;
  }
  var nowSec = Date.now() / 1000;
  $('[data-timer-ends-at]').each(function() {
    var box = $(this);
    var endsAt = parseFloat(box.data('timer-ends-at')) || 0;
    var maxTime = parseFloat(box.data('step-max')) || 120;
    box.find('.progress').show();
    if (!endsAt || endsAt <= 0) return;
    var remaining = Math.max(0, Math.floor(endsAt - nowSec));
    box.find('.timer-value').text(remaining + ' сек');
    box.removeClass('timer-running timer-expired');
    if (remaining <= 0) {
      box.addClass('timer-expired');
      box.find('.timer-value').text('0 сек');
    } else {
      box.addClass('timer-running');
    }
    var percent = Math.round((remaining / maxTime) * 100);
    var bar = box.find('.progress-bar');
    bar.css('width', percent + '%');
    bar.removeClass('bg-success bg-warning bg-danger').addClass(percent <= 25 ? 'bg-danger' : (percent <= 50 ? 'bg-warning' : 'bg-success'));
  });
}

setInterval(updateAllTimers, 1000);
setInterval(fetchPatientsList, 5000);
fetchPatientsList();
updateAllTimers();

$(document).ready(function() {
  // Устанавливаем текущую дату как значение по умолчанию, если параметр не передан
  if (!$('input[name="admission_date"]').val()) {
    $('input[name="admission_date"]').val(new Date().toISOString().split('T')[0]);
  }
  
  var urlParams = new URLSearchParams(window.location.search);
  urlParams.forEach(function(value, key) {
    var el = $('[name="' + key + '"]');
    if (el.length && el.val() !== value) el.val(value);
  });
});
</script>