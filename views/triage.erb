<%# ========== Просмотр триажа пациента (views/triage.erb) ========== %>
<div class="row align-items-start">
  <div class="col-12 col-md-8">
    <h1 class="page-title">Триаж пациента: <%= @patient.full_name %></h1>
    <p class="text-muted">ID: <%= @patient.id %></p>
    <div class="app-card card mb-4">
      <div class="card-body">
        <div class="row">
          <div class="col-md-3">
            <strong>Исполнитель:</strong><br>
            <%= @patient.performer_name %>
          </div>
          <div class="col-md-3">
            <strong>Вид обращения:</strong><br>
            <%= @patient.appeal_type %>
          </div>
          <div class="col-md-3">
            <strong>Срок беременности:</strong><br>
            <%= @patient.pregnancy_display %>
          </div>
          <div class="col-md-3">
            <strong>Дата рождения:</strong><br>
            <%= @patient.birth_date %>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="col-12 col-md-4 mb-3 mb-md-0">
    <div id="triage-timer" class="timer-box timer-running">
      <h4 class="text-center mb-0">
        <i class="bi bi-clock"></i>
        <span id="timer-display"><%= @triage&.time_remaining || 120 %></span> сек
      </h4>
    </div>
  </div>
</div>

<div id="time-expired-warning" class="alert alert-danger d-none">
  <h4><i class="bi bi-exclamation-triangle"></i> Время вышло!</h4>
  <p class="mb-0">Время на заполнение триажа истекло.</p>
</div>

<form id="triage-form" action="/patients/<%= @patient.id %>/triage" method="post" class="mt-4">
  <div class="app-card card mb-4">
    <div class="app-card-header card-header">
      <span class="text-muted small text-uppercase fw-normal">Уровень сознания</span>
    </div>
    <div class="card-body">
      <div class="row g-3">
        <div class="col-md-6">
          <label class="form-label">Открывание глаз</label>
          <select name="eye_opening" class="form-select" required>
            <option value="">Выберите...</option>
            <option value="произвольно открывается">Произвольно открывается</option>
            <option value="глаза закрыты">Глаза закрыты</option>
            <option value="на звук">На звук</option>
            <option value="на боль">На боль</option>
            <option value="нет реакции">Нет реакции</option>
          </select>
        </div>
        
        <div class="col-md-6">
          <label class="form-label">Речевые реакции</label>
          <select name="verbal_response" class="form-select" required>
            <option value="">Выберите...</option>
            <option value="четко">Четко</option>
            <option value="плохо">Плохо</option>
            <option value="непонятные звуки">Непонятные звуки</option>
            <option value="нечленораздельные звуки">Нечленораздельные звуки</option>
            <option value="нет реакции">Нет реакции</option>
          </select>
        </div>
        
        <div class="col-12">
          <label class="form-label">Уровень сознания</label>
          <select name="consciousness_level" class="form-select" required>
            <option value="">Выберите...</option>
            <option value="ясное">Ясное</option>
            <option value="оглушение">Оглушение</option>
            <option value="сопор">Сопор</option>
            <option value="кома">Кома</option>
          </select>
        </div>
      </div>
    </div>
  </div>
  
  <div class="d-grid gap-2 d-md-flex justify-content-md-end">
    <button type="submit" class="btn btn-success btn-lg">
      <i class="bi bi-check-circle"></i> Завершить триаж
    </button>
  </div>
</form>

<script>
// Подключение к SSE потоку
const eventSource = new EventSource('/triage_events/<%= @patient.id %>');

eventSource.onmessage = function(event) {
  const data = JSON.parse(event.data);
  const timerDisplay = $('#timer-display');
  const timerBox = $('#triage-timer');
  const warning = $('#time-expired-warning');
  const form = $('#triage-form');
  
  // Обновление таймера
  timerDisplay.text(data.time_remaining);
  
  if (data.expired) {
    timerBox.removeClass('alert-info').addClass('alert-danger');
    warning.removeClass('d-none');
    
    // Отключаем форму если время вышло
    form.find('select').prop('disabled', true);
    form.find('button').prop('disabled', true);
  }
};

// При закрытии страницы отключаем SSE
window.addEventListener('beforeunload', function() {
  eventSource.close();
});

// Автоматическая отправка формы при завершении времени
function checkAndSubmit() {
  const timeRemaining = parseInt($('#timer-display').text());
  if (timeRemaining <= 0 && $('#triage-form').find('select').filter(function() {
    return $(this).val() !== '';
  }).length > 0) {
    $('#triage-form').submit();
  }
}

// Проверяем каждую секунду
setInterval(checkAndSubmit, 1000);
</script>