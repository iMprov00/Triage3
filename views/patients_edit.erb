<%# Редактирование пациента %>
<div class="row">
  <div class="col-12">
    <div class="app-card card">
      <div class="app-card-header card-header d-flex align-items-center justify-content-between">
        <div>
          <h1 class="page-title mb-0">Редактирование пациента</h1>
          <p class="text-muted small mb-0">ID: <%= @patient.id %></p>
        </div>
        <a href="/patients" class="btn btn-secondary">
          <i class="bi bi-arrow-left"></i> Назад
        </a>
      </div>
      <div class="card-body">
        <form action="/patients/<%= @patient.id %>/edit" method="post" class="row g-3">
          <!-- Основная информация -->
          <div class="col-md-6">
            <label class="form-label">ФИО пациента*</label>
            <input type="text" name="full_name" class="form-control" 
                   value="<%= @patient.full_name %>" required>
          </div>
          
          <div class="col-md-3">
            <label class="form-label">Дата поступления*</label>
            <input type="date" name="admission_date" class="form-control" 
                   value="<%= @patient.admission_date %>" required>
          </div>
          
          <div class="col-md-3">
            <label class="form-label">Время поступления*</label>
            <input type="time" name="admission_time" class="form-control" 
                   value="<%= @patient.admission_time.strftime('%H:%M') rescue '' %>" required>
          </div>
          
          <div class="col-12 col-md-6">
            <label class="form-label">Дата рождения*</label>
            <div class="row g-2">
              <div class="col-4">
                <select name="birth_day" class="form-select" id="birth_day" required>
                  <option value="">День</option>
                  <% (1..31).each do |day| %>
                    <option value="<%= day %>"><%= day %></option>
                  <% end %>
                </select>
              </div>
              <div class="col-4">
                <select name="birth_month" class="form-select" id="birth_month" required>
                  <option value="">Месяц</option>
                  <% 
                    months = [
                      ['Январь', 1], ['Февраль', 2], ['Март', 3], ['Апрель', 4],
                      ['Май', 5], ['Июнь', 6], ['Июль', 7], ['Август', 8],
                      ['Сентябрь', 9], ['Октябрь', 10], ['Ноябрь', 11], ['Декабрь', 12]
                    ]
                  %>
                  <% months.each do |name, value| %>
                    <option value="<%= value %>"><%= name %></option>
                  <% end %>
                </select>
              </div>
              <div class="col-4">
                <select name="birth_year" class="form-select" id="birth_year" required>
                  <option value="">Год</option>
                  <% current_year = Date.today.year %>
                  <% (current_year - 120..current_year).reverse_each do |year| %>
                    <option value="<%= year %>"><%= year %></option>
                  <% end %>
                </select>
              </div>
            </div>
            <!-- Скрытое поле для отправки даты в формате YYYY-MM-DD -->
            <input type="hidden" name="birth_date" id="birth_date_hidden">
          </div>
          
          <div class="col-md-4">
            <label class="form-label">Исполнитель*</label>
            <input type="text" name="performer_name" class="form-control" 
                   value="<%= @patient.performer_name %>" required>
          </div>
          
          <div class="col-md-4">
            <label class="form-label">Вид обращения*</label>
            <select name="appeal_type" class="form-select" required>
              <option value="">Выберите...</option>
              <% Patient::APPEAL_TYPES.each do |type| %>
                <option value="<%= type %>" <%= 'selected' if @patient.appeal_type == type %>>
                  <%= type %>
                </option>
              <% end %>
            </select>
          </div>
          
          <!-- Срок беременности -->
          <div class="col-12">
            <div class="app-card card">
              <div class="app-card-header card-header">
                <span class="text-muted small text-uppercase fw-normal">Срок беременности</span>
              </div>
              <div class="card-body">
                <div class="form-check mb-3">
                  <input class="form-check-input" type="checkbox" name="pregnancy_unknown" 
                         value="1" id="pregnancy_unknown" 
                         <%= 'checked' if @patient.pregnancy_unknown %>>
                  <label class="form-check-label" for="pregnancy_unknown">
                    Неизвестно
                  </label>
                </div>
                
                <div id="pregnancy_weeks_container" 
                     class="<%= @patient.pregnancy_unknown ? 'd-none' : '' %>">
                  <label class="form-label">Срок беременности (недель)</label>
                  <input type="number" name="pregnancy_weeks" class="form-control" 
                         min="1" max="42" step="0.1"
                         value="<%= @patient.pregnancy_weeks %>">
                </div>
              </div>
            </div>
          </div>
          
          <div class="col-12 action-bar mt-4">
            <button type="submit" class="btn btn-success">
              <i class="bi bi-check-lg"></i> Сохранить изменения
            </button>
            <a href="/patients" class="btn btn-secondary">Отмена</a>
            
            <% if @patient.triage&.completed_at %>
              <a href="/patients/<%= @patient.id %>/triage/actions" class="btn btn-info">
                <i class="bi bi-eye"></i> Просмотр триажа
              </a>
            <% end %>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<script>

// Объединяем день, месяц и год в одну дату
function updateBirthDate() {
  const day = document.getElementById('birth_day').value;
  const month = document.getElementById('birth_month').value;
  const year = document.getElementById('birth_year').value;
  
  if (day && month && year) {
    const dateStr = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
    document.getElementById('birth_date_hidden').value = dateStr;
  }
}

// Для редактирования: разбираем существующую дату
<% if @patient %>
  document.addEventListener('DOMContentLoaded', function() {
    const birthDate = '<%= @patient.birth_date %>';
    if (birthDate) {
      const date = new Date(birthDate);
      document.getElementById('birth_day').value = date.getDate();
      document.getElementById('birth_month').value = date.getMonth() + 1;
      document.getElementById('birth_year').value = date.getFullYear();
      updateBirthDate();
    }
  });
<% end %>

// Слушаем изменения в селектах
['birth_day', 'birth_month', 'birth_year'].forEach(id => {
  document.getElementById(id).addEventListener('change', updateBirthDate);
});
  
// Показать/скрыть поле срока беременности
document.getElementById('pregnancy_unknown').addEventListener('change', function() {
  const container = document.getElementById('pregnancy_weeks_container');
  if (this.checked) {
    container.classList.add('d-none');
  } else {
    container.classList.remove('d-none');
  }
});
</script>